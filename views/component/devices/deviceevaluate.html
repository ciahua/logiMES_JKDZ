<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>设备管理评价指标统计表</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../../../layuiadmin/layui/css/layui.css" media="all">
    <!-- 注意：如果你直接复制所有代码到本地，上述css路径需要改成你本地的 -->
</head>
<body>
    <div class="layui-card">
        <div class="layui-card-header">设备管理评价指标统计表</div>
        <div class="layui-card-body">
            <div class="test-table-reload-btn" style="margin-bottom: 10px;">
                搜索内容：
                <div class="layui-inline">
                    <input type="text" class="layui-input" id="test3" placeholder="yyyy-MM">
                </div>
                <button class="layui-btn" id="search" data-type="reload">搜索</button>
            </div>
            <table class="layui-table" id="idTest" lay-filter="demo"></table>
            <p id="records"></p>
        </div>

        <script type="text/html" id="toolbarDemo">
            <div class="layui-btn-container">
                <!--<button class="layui-btn layui-btn-sm" lay-event="addNew">新增</button>-->
            </div>
        </script>

        <script type="text/html" id="barDemo">
            <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
            <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
        </script>
        <script src="../../../Scripts/jquery-3.4.1.js"></script>
        <script type="text/html" id="dayTpl1">

            {{#  if(d.Day1 === '正常'){ }}
            <span class="layui-badge layui-bg-green">√</span>
            {{#  } else if(d.Day1 != '正常'){ }}
            <span class="layui-badge">{{ d.Day1 }}</span>
            {{#  } }}
        </script>
        <script type="text/html" id="dayTpl2">
            {{#  if(d.Day2 === '正常'){ }}
            <span class="layui-badge layui-bg-green">√</span>
            {{#  } else if(d.Day2 != '正常'){ }}
            <span class="layui-badge">{{ d.Day2 }}</span>
            {{#  } }}
        </script>
        <script type="text/html" id="dayTpl3">
            {{#  if(d.Day3 === '正常'){ }}
            <span class="layui-badge layui-bg-green">√</span>
            {{#  } else if(d.Day3 != '正常'){ }}
            <span class="layui-badge">{{ d.Day3 }}</span>
            {{#  } }}
        </script>
        <script type="text/html" id="dayTpl4">
            {{#  if(d.Day4 === '正常'){ }}
            <span class="layui-badge layui-bg-green">√</span>
            {{#  } else if(d.Day4 != '正常'){ }}
            <span class="layui-badge">{{ d.Day4 }}</span>
            {{#  } }}
        </script>
        <script type="text/html" id="dayTpl5">
            {{#  if(d.Day5 === '正常'){ }}
            <span class="layui-badge layui-bg-green">√</span>
            {{#  } else if(d.Day5 != '正常'){ }}
            <span class="layui-badge">{{ d.Day5 }}</span>
            {{#  } }}
        </script>
        <script type="text/html" id="dayTpl6">
            {{#  if(d.Day6 === '正常'){ }}
            <span class="layui-badge layui-bg-green">√</span>
            {{#  } else if(d.Day6 != '正常'){ }}
            <span class="layui-badge">{{ d.Day6 }}</span>
            {{#  } }}
        </script>
        <script type="text/html" id="dayTpl7">
            {{#  if(d.Day7 === '正常'){ }}
            <span class="layui-badge layui-bg-green">√</span>
            {{#  } else if(d.Day7 != '正常'){ }}
            <span class="layui-badge">{{ d.Day7 }}</span>
            {{#  } }}
        </script>
        <script type="text/html" id="dayTpl8">
            {{#  if(d.Day8 === '正常'){ }}
            <span class="layui-badge layui-bg-green">√</span>
            {{#  } else if(d.Day8 != '正常'){ }}
            <span class="layui-badge">{{ d.Day8 }}</span>
            {{#  } }}
        </script>
        <script type="text/html" id="dayTpl9">
            {{#  if(d.Day9 === '正常'){ }}
            <span class="layui-badge layui-bg-green">√</span>
            {{#  } else if(d.Day9 != '正常'){ }}
            <span class="layui-badge">{{ d.Day9 }}</span>
            {{#  } }}
        </script>
        <script type="text/html" id="dayTpl10">
            {{#  if(d.Day10 === '正常'){ }}
            <span class="layui-badge layui-bg-green">√</span>
            {{#  } else if(d.Day10 != '正常'){ }}
            <span class="layui-badge">{{ d.Day10 }}</span>
            {{#  } }}
        </script>
        <script type="text/html" id="dayTpl11">
            {{#  if(d.Day11 === '正常'){ }}
            <span class="layui-badge layui-bg-green">√</span>
            {{#  } else if(d.Day11 != '正常'){ }}
            <span class="layui-badge">{{ d.Day11 }}</span>
            {{#  } }}
        </script>
        <script type="text/html" id="dayTpl12">
            {{#  if(d.Day12 === '正常'){ }}
            <span class="layui-badge layui-bg-green">√</span>
            {{#  } else if(d.Day12 != '正常'){ }}
            <span class="layui-badge">{{ d.Day12 }}</span>
            {{#  } }}
        </script>
        <script type="text/html" id="dayTpl13">
            {{#  if(d.Day13 === '正常'){ }}
            <span class="layui-badge layui-bg-green">√</span>
            {{#  } else if(d.Day13 != '正常'){ }}
            <span class="layui-badge">{{ d.Day13 }}</span>
            {{#  } }}
        </script>
        <script type="text/html" id="dayTpl14">
            {{#  if(d.Day14 === '正常'){ }}
            <span class="layui-badge layui-bg-green">√</span>
            {{#  } else if(d.Day14 != '正常'){ }}
            <span class="layui-badge">{{ d.Day14 }}</span>
            {{#  } }}
        </script>
        <script type="text/html" id="dayTpl15">
            {{#  if(d.Day15 === '正常'){ }}
            <span class="layui-badge layui-bg-green">√</span>
            {{#  } else if(d.Day15 != '正常'){ }}
            <span class="layui-badge">{{ d.Day15 }}</span>
            {{#  } }}
        </script>
        <script type="text/html" id="dayTpl16">
            {{#  if(d.Day16 === '正常'){ }}
            <span class="layui-badge layui-bg-green">√</span>
            {{#  } else if(d.Day16 != '正常'){ }}
            <span class="layui-badge">{{ d.Day16 }}</span>
            {{#  } }}
        </script>
        <script type="text/html" id="dayTpl17">
            {{#  if(d.Day17 === '正常'){ }}
            <span class="layui-badge layui-bg-green">√</span>
            {{#  } else if(d.Day17 != '正常'){ }}
            <span class="layui-badge">{{ d.Day17 }}</span>
            {{#  } }}
        </script>
        <script type="text/html" id="dayTpl18">
            {{#  if(d.Day18 === '正常'){ }}
            <span class="layui-badge layui-bg-green">√</span>
            {{#  } else if(d.Day18 != '正常'){ }}
            <span class="layui-badge">{{ d.Day18 }}</span>
            {{#  } }}
        </script>
        <script type="text/html" id="dayTpl19">
            {{#  if(d.Day19 === '正常'){ }}
            <span class="layui-badge layui-bg-green">√</span>
            {{#  } else if(d.Day19 != '正常'){ }}
            <span class="layui-badge">{{ d.Day19 }}</span>
            {{#  } }}
        </script>
        <script type="text/html" id="dayTpl20">
            {{#  if(d.Day20 === '正常'){ }}
            <span class="layui-badge layui-bg-green">√</span>
            {{#  } else if(d.Day20 != '正常'){ }}
            <span class="layui-badge">{{ d.Day20 }}</span>
            {{#  } }}
        </script>
        <script type="text/html" id="dayTpl21">
            {{#  if(d.Day21 === '正常'){ }}
            <span class="layui-badge layui-bg-green">√</span>
            {{#  } else if(d.Day21 != '正常'){ }}
            <span class="layui-badge">{{ d.Day21 }}</span>
            {{#  } }}
        </script>
        <script type="text/html" id="dayTpl22">
            {{#  if(d.Day22 === '正常'){ }}
            <span class="layui-badge layui-bg-green">√</span>
            {{#  } else if(d.Day22 != '正常'){ }}
            <span class="layui-badge">{{ d.Day22 }}</span>
            {{#  } }}
        </script>
        <script type="text/html" id="dayTpl23">
            {{#  if(d.Day23 === '正常'){ }}
            <span class="layui-badge layui-bg-green">√</span>
            {{#  } else if(d.Day23 != '正常'){ }}
            <span class="layui-badge">{{ d.Day23 }}</span>
            {{#  } }}
        </script>
        <script type="text/html" id="dayTpl24">
            {{#  if(d.Day24 === '正常'){ }}
            <span class="layui-badge layui-bg-green">√</span>
            {{#  } else if(d.Day24 != '正常'){ }}
            <span class="layui-badge">{{ d.Day24 }}</span>
            {{#  } }}
        </script>
        <script type="text/html" id="dayTpl25">
            {{#  if(d.Day25 === '正常'){ }}
            <span class="layui-badge layui-bg-green">√</span>
            {{#  } else if(d.Day25 != '正常'){ }}
            <span class="layui-badge">{{ d.Day25 }}</span>
            {{#  } }}
        </script>
        <script type="text/html" id="dayTpl26">
            {{#  if(d.Day26 === '正常'){ }}
            <span class="layui-badge layui-bg-green">√</span>
            {{#  } else if(d.Day26 != '正常'){ }}
            <span class="layui-badge">{{ d.Day26 }}</span>
            {{#  } }}
        </script>
        <script type="text/html" id="dayTpl27">
            {{#  if(d.Day27 === '正常'){ }}
            <span class="layui-badge layui-bg-green">√</span>
            {{#  } else if(d.Day27 != '正常'){ }}
            <span class="layui-badge">{{ d.Day27 }}</span>
            {{#  } }}
        </script>
        <script type="text/html" id="dayTpl28">
            {{#  if(d.Day28 === '正常'){ }}
            <span class="layui-badge layui-bg-green">√</span>
            {{#  } else if(d.Day28 != '正常'){ }}
            <span class="layui-badge">{{ d.Day28 }}</span>
            {{#  } }}
        </script>
        <script type="text/html" id="dayTpl29">
            {{#  if(d.Day29 === '正常'){ }}
            <span class="layui-badge layui-bg-green">√</span>
            {{#  } else if(d.Day29 != '正常'){ }}
            <span class="layui-badge">{{ d.Day29 }}</span>
            {{#  } }}
        </script>
        <script type="text/html" id="dayTpl30">
            {{#  if(d.Day30 === '正常'){ }}
            <span class="layui-badge layui-bg-green">√</span>
            {{#  } else if(d.Day30 != '正常'){ }}
            <span class="layui-badge">{{ d.Day30 }}</span>
            {{#  } }}
        </script>
        <script type="text/html" id="dayTpl31">
            {{#  if(d.Day31 === '正常'){ }}
            <span class="layui-badge layui-bg-green">√</span>
            {{#  } else if(d.Day31 != '正常'){ }}
            <span class="layui-badge">{{ d.Day31 }}</span>
            {{#  } }}
        </script>
    </div>

    <script src="../../../layuiadmin/layui/layui.js" charset="utf-8"></script>
    <script src="../../../Scripts/mestools.js"></script>
    <!-- 注意：如果你直接复制所有代码到本地，上述js路径需要改成你本地的 -->
    <script>
        layui.use(['tree', 'util', 'table', 'laypage','laydate'], function () {
            var table = layui.table;
            var form = layui.form
                , $ = layui.$
                , layer = layui.layer
                , layedit = layui.layedit
                , laydate = layui.laydate

            var myDate = new Date();
            //获取当前年
            var year = myDate.getFullYear();
            //获取上月
            var month = myDate.getMonth();
            if (month === 0) {
                year = year - 1;
                month = 12;
            }
            var ym = year + '-' + month;

            //年月选择器
            laydate.render({
                elem: '#test3'
                , type: 'month'
                , value: ym
                , isInitValue: true
                , trigger: 'click'
                , change: function (value, date, endDate) {
                    if ($(event.target).hasClass("layui-this")) {
                        $(this.elem).val(value);
                        $(".layui-laydate").remove();
                    }
                }
            });

            var colsContent = [[
                { type: 'numbers', fixed: 'left', rowspan: 2 }
                //, { type: 'checkbox', fixed: 'left', rowspan: 2 }
                //, { field: 'Id', title: 'ID', width: 80, sort: true, fixed: true, rowspan: 2 }
                , { field: 'DevNo', title: '设备号', width: 100, sort: true, rowspan: 2 }
                , { field: 'DevName', title: '设备名称', width: 100, sort: true, rowspan: 2 }
                , { field: 'DevType', title: '规格型号', width: 100, sort: true, rowspan: 2 }
                , { field: 'DevDept', title: '使用部门', width: 100, sort: true, rowspan: 2 }
                //, { title: '专业保养日期', colspan: 2 }
                , { title: '计划工作时间', align: 'center', colspan: 2 }
                , { field: 'WorkHours', title: '正常运行时间(h)', align: 'center', rowspan: 2 }
                , { field: 'FailHours', title: '故障时间(h)', align: 'center', rowspan: 2 }
                , { field: 'OtherHours', title: '其它停机时间(h)', align: 'center', rowspan: 2 }
                , { field: 'FaultCount', title: '故障次数', align: 'center', width: 100, rowspan: 2 }
                , {
                    field: 'MTBF', title: 'MTBF值(h)', rowspan: 2, templet: function (d) {
                        if (d.FaultCount != 0) {
                            var mtbf = (d.RegularWorkHours * d.RegularWorkDays / d.FaultCount).toFixed(2);
                            return mtbf;
                        } else {
                            return '-';
                        }
                    }
                }
                , {
                    field: 'MTTR', title: 'MTTR值(h)', rowspan: 2, templet: function (d) {
                        if (d.FaultCount != 0) {
                            var mttr = (d.FailHours / d.FaultCount).toFixed(2);
                            return mttr;
                        } else {
                            return '-';
                        }
                    }
                }
                , {
                    field: 'MTTF', title: 'MTTF值(h)', rowspan: 2, templet: function (d) {
                        if (d.FaultCount != 0) {
                            var mttf = d.WorkHours / d.FaultCount;
                            return mttf;
                        } else {
                            return '-';
                        }
                    }
                }
                , {
                    field: 'FailRate', title: '故障停机率(%)', rowspan: 2, templet: function (d) {
                        var n = d.WorkHours * 1 + d.FailHours * 1;
                        if (n != 0) {
                            var failrate = (d.FailHours * 100 / n).toFixed(2) + '%';
                            return failrate;
                        } else {
                            return '-';
                        }

                    }
                }
                , {
                    field: 'UseRate', title: '设备利用率(%)', rowspan: 2, templet: function (d) {
                        var userate = (d.WorkHours * 100 / (d.RegularWorkHours * d.RegularWorkDays)).toFixed(2) + '%';
                        return userate;
                    }
                }
                , {
                    field: 'OEE', title: 'OEE值(%)', rowspan: 2, templet: function (d) {
                        var totalHours = d.RegularWorkHours * d.RegularWorkDays;
                        var totalActualHours = (d.WorkHours * 1 + d.FailHours * 1);
                        if (totalActualHours != '' && totalActualHours != 0) {
                            var o1 = (d.WorkHours / totalHours);
                            var o2 = 0.85; //(d.WorkHours / totalActualHours);
                            var oee = (o1 * o2 * 100 * 1 * 1).toFixed(2) + '%';
                            return oee;
                        } else {
                            return '-';
                        }
                    }
                }
                //, { fixed: 'right', minWidth: 150, align: 'center', toolbar: '#barDemo', rowspan:2 }
            ], [
                //{ field: 'ExpMaintainLast', title: '上次' }
                //, { field: 'ExpMaintainCurr', title: '本次' }
                { field: 'RegularWorkHours', title: '日工作时间(h)', align: 'center' }
                , { field: 'RegularWorkDays', title: '工作天数(天)', align: 'center' }
            ]];

            var tn = 'tbdeviceevaluate';//存储表名
            colsContent = MesTools.GetHideCols2(tn, colsContent, $);

            //所获得的 tableIns 即为当前容器的实例
            var tableIns = table.render({
                elem: '#idTest'
                , id: 'idTest'
                , url: '../../../Handlers/Handler-evaluate.ashx'
                , where: { actid: 'getEvlTable', yearmonth: ym }
                , cols: colsContent
                , height: 640
                , cellMinWidth: 120
                , toolbar: '#toolbarDemo'
                , defaultToolbar: ['filter', 'print', 'exports', {
                    title: '保存列设置' //标题
                    , layEvent: 'LAYTABLE_TIPS' //事件名，用于 toolbar 事件中使用
                    , icon: 'layui-icon-tips' //图标类名
                }]
                , done: function (res) {
                    //console.log(res.data);
                    var data = res.data;
                    var sumMtbf = 0;
                    var totalFaultCount = 0;
                    var totalFailHours = 0;
                    var totalWorkHours = 0;
                    var avgFailRate = 0;
                    var avgUseRate = 0;
                    $.each(data, function (i, o) {
                        var mtbf = data[i].RegularWorkHours * data[i].RegularWorkDays;
                        sumMtbf += mtbf;
                        totalFaultCount += data[i].FaultCount * 1;
                        totalFailHours += data[i].FailHours * 1;
                        totalWorkHours += data[i].WorkHours * 1;                        
                    }); 

                    sumMtbf = sumMtbf.toFixed(2);
                    totalFaultCount = totalFaultCount.toFixed(0);
                    totalFailHours = totalFailHours.toFixed(2);
                    totalWorkHours = totalWorkHours.toFixed(2)
                    //console.log('------');
                    //console.log(sumMtbf);//总的计划工作时间
                    //console.log(totalFaultCount);//总的故障次数
                    //console.log(totalFailHours);//总的故障运行时间
                    //console.log(totalWorkHours);//总的正常时间
                    var MTBF=0, MTTR=0, MTTF=0;
                    if (totalFaultCount != 0) {
                        MTBF = (sumMtbf / totalFaultCount).toFixed(2);
                        //console.log(MTBF);
                        MTTR = (totalFailHours / totalFaultCount).toFixed(2);
                        //console.log(MTTR);
                        MTTF = (totalWorkHours / totalFaultCount).toFixed(2);
                        //console.log(MTTF);
                    }
                    if (parseInt(totalFailHours + totalWorkHours) != 0) {
                        avgFailRate = (totalFailHours * 100 / (totalFailHours*1 + totalWorkHours*1)).toFixed(2) + '%';
                        //console.log('--------比率-------');
                        //console.log(avgFailRate);
                    }
                    
                    avgUseRate = (totalWorkHours/sumMtbf*100).toFixed(2)+'%';
                    //console.log(avgUseRate);
                }
            });

            var $ = layui.$, active = {
                reload: function () {
                    var demoReload = $('#test3');

                    //执行重载
                    table.reload('idTest', {
                        //page: {
                        //    curr: 1 //重新从第 1 页开始
                        //}
                        //where: { actid: 'getDailyReport', yearmonth: demoReload.val() }
                        where: { actid: 'getEvlTable', yearmonth: demoReload.val() }
                    }, 'data');
                }
            };

            $('#search').on('click', function () {
                var type = $(this).data('type');
                active[type] ? active[type].call(this) : '';
            });

            //头工具栏事件
            table.on('toolbar(demo)', function (obj) {
                var checkStatus = table.checkStatus(obj.config.id);
                switch (obj.event) {
                    case 'addNew':
                        //var data = checkStatus.data;
                        //layer.alert(JSON.stringify(data));
                        //页面层

                        layer.open({
                            title: '添加设备',
                            type: 2,
                            skin: 'layui-layer-rim', //加上边框
                            area: ['1024px', '768px'], //宽高
                            content: 'devadd.html'
                        });
                        break;
                    case 'getCheckLength':
                        var data = checkStatus.data;
                        layer.msg('选中了：' + data.length + ' 个');
                        break;
                    case 'isAll':
                        layer.msg(checkStatus.isAll ? '全选' : '未全选');
                        break;

                    //自定义头工具栏右侧图标 - 提示
                    case 'LAYTABLE_TIPS':
                        layer.msg('已保存列设置');
                        MesTools.SetHideCols2('idTest', tn, table);
                        break;
                };
            });

            //监听行工具事件
            table.on('tool(demo)', function (obj) {
                var data = obj.data;
                if (obj.event === 'del') {
                    layer.confirm('真的删除该行么？', function (index) {
                        obj.del();
                        layer.close(index);
                        $.ajax({
                            url: '../../../Handlers/Handler-devicelist.ashx',
                            data: { actid: 'delTable', data: JSON.stringify(data) },
                            success: function (res) {
                                alert("删除成功！");
                                //假设这是iframe页
                                //var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
                                //parent.layer.close(index); //再执行关闭

                                ////这里以搜索为例
                                //tableIns.reload({
                                //    where: { actid: 'getTable' }
                                //    , page: {
                                //        curr: 1 //重新从第 1 页开始
                                //    }
                                //});
                            },
                            error: function (e) {
                                console.log(e);
                                alert('删除失败！');
                            }
                        });
                    });
                } else if (obj.event === 'edit') {
                    //layer.alert(JSON.stringify(data));

                    layer.open({
                        title: '编辑设备',
                        type: 2,
                        skin: 'layui-layer-rim', //加上边框
                        area: ['1024px', '768px'], //宽高
                        content: 'devedit.html',
                        success: function (layero, index) {
                            var body = layer.getChildFrame('body', index);
                            var iframeWin = window[layero.find('iframe')[0]['name']]; //得到iframe页的窗口对象，执行iframe页的方法：iframeWin.method();
                            //console.log(body.html()); //得到iframe页的body内容
                            //body.find('input').val('Hi，我是从父页来的')
                            //body.find('example').val(data);
                            //setTimeout(function () { body.find('#LAY-component-form-setval').trigger('click') }, 100);
                            body.find("input[name='id']").val(data.Id);
                            body.find("input[name='devno']").val(data.DevNo);
                            body.find("input[name='devname']").val(data.DevName);
                            body.find("input[name='devtype']").val(data.DevType);
                            body.find("input[name='quantity']").val(data.Quantity);
                            body.find("input[name='vender']").val(data.Vender);
                            body.find("input[name='devdept']").val(data.DevDept);
                            body.find("input[name='buydate']").val(data.BuyDate);
                            body.find("input[name='lifetime']").val(data.LifeTime);
                            body.find("input[name='devclass']").val(data.DevClass);

                            body.find("input[name='special']").val(data.Special);
                            body.find("input[name='capacity']").val(data.Capacity);
                            body.find("input[name='devstate']").val(data.DevState);
                            body.find("input[name='importance']").val(data.Importance);
                            body.find("input[name='value']").val(data.Value);
                            body.find("input[name='changedate']").val(data.ChangeDate);
                            body.find("textarea[name='desc']").val(data.ChangeDesc);

                        }
                    });

                    //layer.prompt({
                    //    formType: 2
                    //    , value: data.DevNo
                    //}, function (value, index) {
                    //    obj.update({
                    //        DevNo: value
                    //    });
                    //    layer.close(index);
                    //});
                }
            });

            //监听单元格事件
            table.on('edit(demo)', function (obj) {
                var data = obj.data;
                console.log(data);
                
                if (data.WorkDays !== '' && data.WorkHours !== '' && data.FailTimes !== '' && data.FailTimes !== '0') {
                    var mtbf = (data.WorkDays * data.WorkHours) / data.FailTimes;    
                    obj.update({
                        MTBF: mtbf
                    });
                }                
            });
        });
    </script>

</body>
</html>